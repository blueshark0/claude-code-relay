<template>
  <div>
    <t-card class="list-card-container" :bordered="false">
      <t-row justify="space-between">
        <div class="left-operation-container">
          <t-button @click="handleCreate"> 创建密钥 </t-button>
        </div>
        <div class="search-input">
          <t-input v-model="searchValue" placeholder="搜索密钥名称" clearable @enter="handleSearch">
            <template #suffix-icon>
              <search-icon size="16px" />
            </template>
          </t-input>
        </div>
      </t-row>

      <t-table
        :data="data"
        :columns="COLUMNS"
        :row-key="rowKey"
        vertical-align="top"
        :hover="true"
        :pagination="pagination"
        :selected-row-keys="selectedRowKeys"
        :loading="dataLoading"
        :header-affixed-top="headerAffixedTop"
        @page-change="handlePageChange"
        @select-change="handleSelectChange"
      >
        <template #user_id="{ row }">
          <t-tag theme="default" variant="light"> {{ row.user_id }} </t-tag>
        </template>

        <template #status="{ row }">
          <t-tag v-if="row.status === 1" theme="success" variant="light"> 启用 </t-tag>
          <t-tag v-else theme="danger" variant="light"> 禁用 </t-tag>
        </template>

        <template #today_usage_count="{ row }">
          <t-tag theme="default" variant="light"> {{ row.today_usage_count || 0 }} </t-tag>
        </template>

        <template #today_total_cost="{ row }">
          <span>${{ (row.today_total_cost || 0).toFixed(4) }}</span>
        </template>

        <template #weekly_count="{ row }">
          <t-tag theme="default" variant="light"> {{ row.weekly_count || 0 }} </t-tag>
        </template>

        <template #weekly_cost="{ row }">
          <span>${{ (row.weekly_cost || 0).toFixed(4) }}</span>
        </template>

        <template #daily_limit="{ row }">
          <t-tag theme="default" variant="light"> ${{ row.daily_limit }} </t-tag>
        </template>

        <template #total_limit="{ row }">
          <t-tag theme="primary" variant="light"> ${{ row.total_limit }} </t-tag>
        </template>

        <template #total_cost="{ row }">
          <span class="total-cost">
            ${{ (row.total_cost || 0).toFixed(4) }}
            <t-progress
              v-if="row.total_limit > 0"
              :percentage="Math.min((row.total_cost / row.total_limit) * 100, 100)"
              :status="getUsageStatus(row.total_cost, row.total_limit)"
              theme="line"
              size="small"
              style="margin-top: 4px; width: 60px"
            />
          </span>
        </template>

        <template #model_restriction="{ row }">
          <t-tag v-if="row.model_restriction" theme="default" variant="light"> 限制 </t-tag>
          <span v-else class="text-placeholder">不限制 </span>
        </template>

        <template #expires_at="{ row }">
          <span v-if="row.expires_at">
            {{ formatDateTime(row.expires_at) }}
          </span>
          <span v-else class="text-placeholder">永不过期</span>
        </template>

        <template #group="{ row }">
          <t-tag v-if="row.group" variant="outline">
            {{ row.group.name }}
          </t-tag>
          <span v-else class="text-placeholder">全局共享组</span>
        </template>

        <template #rpm_status="{ row }">
          <div v-if="row.rpm_stats" class="rpm-tpm-status-cell">
            <div class="usage-info">
              <span class="current-value" :class="{ 'text-danger': row.rpm_stats.is_rpm_limited }">
                {{ formatRpmTpmValue(row.rpm_stats.current_rpm) }}
              </span>
              <span v-if="row.rpm_stats.rpm_limit > 0" class="limit-value">
                / {{ formatRpmTpmValue(row.rpm_stats.rpm_limit) }}
              </span>
              <span v-else class="unlimited-text">无限制</span>
            </div>
            <usage-progress
              title="RPM"
              :current="row.rpm_stats.current_rpm"
              :limit="row.rpm_stats.rpm_limit"
              :warning-threshold="row.rpm_stats.rpm_warning_threshold"
              :is-limited="row.rpm_stats.is_rpm_limited"
              compact
            />
          </div>
          <span v-else class="text-placeholder">暂无数据</span>
        </template>

        <template #tpm_status="{ row }">
          <div v-if="row.rpm_stats" class="rpm-tpm-status-cell">
            <div class="usage-info">
              <span class="current-value" :class="{ 'text-danger': row.rpm_stats.is_tpm_limited }">
                {{ formatRpmTpmValue(row.rpm_stats.current_tpm) }}
              </span>
              <span v-if="row.rpm_stats.tpm_limit > 0" class="limit-value">
                / {{ formatRpmTpmValue(row.rpm_stats.tpm_limit) }}
              </span>
              <span v-else class="unlimited-text">无限制</span>
            </div>
            <usage-progress
              title="TPM"
              :current="row.rpm_stats.current_tpm"
              :limit="row.rpm_stats.tpm_limit"
              :warning-threshold="row.rpm_stats.tpm_warning_threshold"
              :is-limited="row.rpm_stats.is_tpm_limited"
              compact
            />
          </div>
          <span v-else class="text-placeholder">暂无数据</span>
        </template>

        <template #rpm_tpm_alerts="{ row }">
          <alert-badge
            v-if="row.rpm_stats"
            :rpm-current="row.rpm_stats.current_rpm"
            :rpm-limit="row.rpm_stats.rpm_limit"
            :rpm-warning-threshold="row.rpm_stats.rpm_warning_threshold"
            :is-rpm-limited="row.rpm_stats.is_rpm_limited"
            :tpm-current="row.rpm_stats.current_tpm"
            :tpm-limit="row.rpm_stats.tpm_limit"
            :tpm-warning-threshold="row.rpm_stats.tpm_warning_threshold"
            :is-tpm-limited="row.rpm_stats.is_tpm_limited"
            :is-rate-limited="!!row.rate_limit_end_time"
            :rate-limit-end-time="row.rate_limit_end_time"
            simple
          />
          <span v-else class="text-placeholder">-</span>
        </template>

        <template #op="{ row }">
          <t-space size="2px">
            <t-button variant="text" size="small" @click="copyToClipboard(row.key)"> 复制 </t-button>
            <t-button variant="text" size="small" theme="primary" @click="handleEdit(row)"> 编辑 </t-button>
            <t-button
              variant="text"
              size="small"
              :theme="row.status === 1 ? 'warning' : 'success'"
              @click="handleToggleStatus(row)"
            >
              {{ row.status === 1 ? '禁用' : '启用' }}
            </t-button>
            <t-dropdown :options="getActionMenuOptions(row)" @click="handleActionMenu($event, row)">
              <t-button variant="text" size="small">
                <template #icon>
                  <t-icon name="more" />
                </template>
              </t-button>
            </t-dropdown>
            <t-button variant="text" size="small" theme="danger" @click="handleDelete([row])"> 删除 </t-button>
          </t-space>
        </template>
      </t-table>
    </t-card>

    <!-- 创建/编辑密钥弹窗 -->
    <t-dialog
      v-model:visible="formVisible"
      :header="editingItem ? '编辑密钥' : '创建密钥'"
      width="600px"
      placement="center"
      @confirm="handleFormConfirm"
      @cancel="handleFormCancel"
    >
      <t-form ref="formRef" :model="formData" label-align="top" label-width="120px">
        <t-form-item label="密钥名称" name="name">
          <t-input v-model="formData.name" placeholder="请输入密钥名称" />
        </t-form-item>

        <t-form-item label="自定义密钥" name="key">
          <t-input v-model="formData.key" placeholder="留空将自动生成" :disabled="!!editingItem" />
          <template #help>
            <span v-if="editingItem">密钥创建后不可修改</span>
            <span v-else>留空将自动生成 sk- 开头的密钥</span>
          </template>
        </t-form-item>

        <t-form-item label="过期时间" name="expires_at">
          <!-- 快捷有效期按钮 -->
          <div class="preset-buttons">
            <t-button size="small" variant="outline" @click="setPresetExpiration(1)">1天后</t-button>
            <t-button size="small" variant="outline" @click="setPresetExpiration(3)">3天后</t-button>
            <t-button size="small" variant="outline" @click="setPresetExpiration(7)">7天后</t-button>
          </div>
          <t-date-picker
            v-model="formData.expires_at"
            format="YYYY-MM-DD HH:mm:ss"
            :disable-date="disableDate"
            :enable-time-picker="true"
            :need-confirm="true"
            default-time="23:59:59"
            clearable
            placeholder="留空表示永不过期"
            style="width: 100%"
          />
        </t-form-item>

        <t-form-item label="分组" name="group_id">
          <t-select v-model="formData.group_id" placeholder="请选择分组" clearable :loading="groupOptionsLoading">
            <t-option :value="0" label="全局共享组" />
            <t-option v-for="group in groupOptions" :key="group.id" :value="group.id" :label="group.name" />
          </t-select>
        </t-form-item>

        <t-form-item label="状态" name="status">
          <t-radio-group v-model="formData.status">
            <t-radio :value="1">启用</t-radio>
            <t-radio :value="0">禁用</t-radio>
          </t-radio-group>
        </t-form-item>

        <t-form-item label="模型限制" name="model_restriction">
          <t-input v-model="formData.model_restriction" placeholder="多个模型用逗号分隔，留空表示不限制" />
          <template #help> 例如：claude-3-5-sonnet-20241022,claude-3-haiku-20240307 </template>
        </t-form-item>

        <t-form-item label="每日限额(美元)" name="daily_limit">
          <t-input-number
            v-model="formData.daily_limit"
            :min="0"
            :step="0.01"
            placeholder="0表示不限制"
            style="width: 100%"
          />
        </t-form-item>

        <t-form-item label="总限额(美元)" name="total_limit">
          <t-input-number
            v-model="formData.total_limit"
            :min="0"
            :step="0.01"
            placeholder="0表示不限制"
            style="width: 100%"
          />
          <template #help> 累计使用金额上限，不会重置 </template>
        </t-form-item>
      </t-form>
    </t-dialog>

    <!-- 删除确认弹窗 -->
    <t-dialog
      v-model:visible="deleteVisible"
      header="确认删除"
      @confirm="handleDeleteConfirm"
      @cancel="handleDeleteCancel"
    >
      <p>{{ deleteConfirmText }}</p>
    </t-dialog>
  </div>
</template>
<script setup lang="ts">
import dayjs from 'dayjs';
import { SearchIcon } from 'tdesign-icons-vue-next';
import type { FormInstanceFunctions, PrimaryTableCol, TableRowData } from 'tdesign-vue-next';
import { MessagePlugin } from 'tdesign-vue-next';
import { computed, h, onMounted, reactive, ref } from 'vue';

import type { ApiKey, CreateApiKeyRequest, UpdateApiKeyRequest } from '@/api/apikey';
import { createApiKey, deleteApiKey, getApiKeys, updateApiKey, updateApiKeyStatus } from '@/api/apikey';
import type { Group } from '@/api/group';
import { getAllGroups } from '@/api/group';
import type { RpmTpmStats } from '@/api/rpm-tpm';
import { formatRpmTpmValue, getApiKeyRpmTpmStats } from '@/api/rpm-tpm';
import AlertBadge from '@/components/rpm-tpm/AlertBadge.vue';
import UsageProgress from '@/components/rpm-tpm/UsageProgress.vue';
import { prefix } from '@/config/global';
import { useSettingStore } from '@/store';

defineOptions({
  name: 'ApiKeysList',
});

const store = useSettingStore();

// 表格列定义
const COLUMNS: PrimaryTableCol<TableRowData>[] = [
  {
    title: 'ID',
    align: 'left',
    width: 100,
    colKey: 'id',
  },
  {
    title: '密钥名称',
    align: 'left',
    width: 180,
    colKey: 'name',
    ellipsis: true,
  },
  { title: '状态', colKey: 'status', width: 100 },
  { title: '用户ID', colKey: 'user_id', width: 100 },
  {
    title: '分组',
    colKey: 'group',
    width: 140,
  },
  {
    title: '今日使用',
    colKey: 'today_usage_count',
    width: 140,
  },
  {
    title: '今日费用',
    colKey: 'today_total_cost',
    width: 160,
  },
  {
    title: '本周使用',
    colKey: 'weekly_count',
    width: 140,
  },
  {
    title: '本周费用',
    colKey: 'weekly_cost',
    width: 160,
  },
  {
    title: '过期时间',
    colKey: 'expires_at',
    width: 180,
  },
  {
    title: '每日限额',
    colKey: 'daily_limit',
    width: 120,
  },
  {
    title: '总限额',
    colKey: 'total_limit',
    width: 120,
  },
  {
    title: '累计费用',
    colKey: 'total_cost',
    width: 160,
  },
  {
    title: '限制模型',
    colKey: 'model_restriction',
    width: 100,
  },
  {
    title: 'RPM 状态',
    colKey: 'rpm_status',
    width: 160,
  },
  {
    title: 'TPM 状态',
    colKey: 'tpm_status',
    width: 160,
  },
  {
    title: 'RPM/TPM 告警',
    colKey: 'rpm_tpm_alerts',
    width: 120,
  },
  {
    title: '最后使用时间',
    colKey: 'last_used_time',
    width: 180,
  },
  {
    title: '创建时间',
    colKey: 'created_at',
    width: 180,
    cell: (h, { row }) => formatDateTime(row.created_at),
  },
  {
    title: '操作',
    align: 'center',
    fixed: 'right',
    width: 180,
    colKey: 'op',
  },
];

// 扩展的 API Key 接口
interface ExtendedApiKey extends ApiKey {
  rpm_stats?: RpmTpmStats;
}

// 数据相关
const data = ref<ExtendedApiKey[]>([]);
const dataLoading = ref(false);
const selectedRowKeys = ref<(string | number)[]>([]);
const searchValue = ref('');

// 分页
const pagination = ref({
  current: 1,
  pageSize: 20,
  total: 0,
  showJumper: true,
  showSizeChanger: true,
});

// 表单相关
const formVisible = ref(false);
const formRef = ref<FormInstanceFunctions>();
const editingItem = ref<ApiKey | null>(null);
const formData = reactive<CreateApiKeyRequest & UpdateApiKeyRequest>({
  name: '',
  key: '',
  expires_at: '',
  status: 1,
  group_id: 0,
  model_restriction: '',
  daily_limit: 0,
  total_limit: 0,
});

// 删除相关
const deleteVisible = ref(false);
const deleteItems = ref<ApiKey[]>([]);

// 分组相关
const groupOptions = ref<Group[]>([]);
const groupOptionsLoading = ref(false);

// 计算属性
const headerAffixedTop = computed(
  () =>
    ({
      offsetTop: store.isUseTabsRouter ? 48 : 0,
      container: `.${prefix}-layout`,
    }) as any,
);

const rowKey = 'id';

const deleteConfirmText = computed(() => {
  if (deleteItems.value.length === 1) {
    return `确认删除密钥 "${deleteItems.value[0].name}" 吗？删除后无法恢复。`;
  }
  return `确认删除选中的 ${deleteItems.value.length} 个密钥吗？删除后无法恢复。`;
});

// 方法
const fetchData = async () => {
  dataLoading.value = true;
  try {
    const params = {
      page: pagination.value.current,
      limit: pagination.value.pageSize,
    };
    const result = await getApiKeys(params);
    const apiKeys = result.api_keys || [];

    // 批量获取 RPM/TPM 数据
    const extendedApiKeys = await Promise.all(
      apiKeys.map(async (apiKey) => {
        try {
          const rpmTpmData = await getApiKeyRpmTpmStats(apiKey.id);
          return {
            ...apiKey,
            rpm_stats: rpmTpmData.data,
          };
        } catch (error) {
          console.warn(`Failed to load RPM/TPM data for API key ${apiKey.id}:`, error);
          return {
            ...apiKey,
            rpm_stats: undefined,
          };
        }
      }),
    );

    data.value = extendedApiKeys;
    pagination.value = {
      ...pagination.value,
      total: result.total || 0,
    };
  } catch (error) {
    console.error('获取密钥列表失败:', error);
    MessagePlugin.error('获取密钥列表失败');
  } finally {
    dataLoading.value = false;
  }
};

const handleSearch = () => {
  pagination.value.current = 1;
  fetchData();
};

const handlePageChange = (pageInfo: any) => {
  pagination.value.current = pageInfo.current;
  pagination.value.pageSize = pageInfo.pageSize;
  fetchData();
};

const handleSelectChange = (value: (string | number)[]) => {
  selectedRowKeys.value = value;
};

// 工具函数
const _maskApiKey = (key: string): string => {
  if (!key) return '';
  if (key.length <= 8) return key;
  return `${key.substring(0, 8)}${'*'.repeat(Math.min(key.length - 8, 20))}`;
};

const copyToClipboard = async (text: string) => {
  try {
    await navigator.clipboard.writeText(text);
    MessagePlugin.success('已复制到剪贴板');
  } catch {
    MessagePlugin.error('复制失败');
  }
};

const _formatNumber = (num: number): string => {
  if (num < 1000) return num.toString();
  if (num < 1000000) return `${(num / 1000).toFixed(1)}K`;
  return `${(num / 1000000).toFixed(1)}M`;
};

const formatDateTime = (dateStr: string): string => {
  if (!dateStr) return '';
  return new Date(dateStr).toLocaleString('zh-CN');
};

const disableDate = (date: Date): boolean => {
  return date < new Date();
};

// 设置快捷有效期
const setPresetExpiration = (days: number) => {
  const expirationDate = dayjs().add(days, 'day').endOf('day').format('YYYY-MM-DD HH:mm:ss');
  formData.expires_at = expirationDate;
};

// 获取分组选项
const fetchGroupOptions = async () => {
  groupOptionsLoading.value = true;
  try {
    groupOptions.value = await getAllGroups();
  } catch (error) {
    console.error('获取分组选项失败:', error);
    MessagePlugin.error('获取分组选项失败');
  } finally {
    groupOptionsLoading.value = false;
  }
};

// 操作相关方法

const handleCreate = async () => {
  editingItem.value = null;
  Object.assign(formData, {
    name: '',
    key: '',
    expires_at: '',
    status: 1,
    group_id: 0,
    model_restriction: '',
    daily_limit: 0,
    total_limit: 0,
  });
  await fetchGroupOptions(); // 加载分组选项
  formVisible.value = true;
};

const handleEdit = async (item: ApiKey) => {
  editingItem.value = item;
  Object.assign(formData, {
    name: item.name,
    key: item.key,
    expires_at: item.expires_at || '',
    status: item.status,
    group_id: item.group_id,
    model_restriction: item.model_restriction || '',
    daily_limit: item.daily_limit,
    total_limit: item.total_limit,
  });
  await fetchGroupOptions(); // 加载分组选项
  formVisible.value = true;
};

const handleFormConfirm = async () => {
  const valid = await formRef.value?.validate();
  if (!valid) return;

  try {
    if (editingItem.value) {
      // 编辑
      const updateData: UpdateApiKeyRequest = {
        name: formData.name,
        expires_at: formData.expires_at || undefined,
        status: formData.status,
        group_id: formData.group_id,
        model_restriction: formData.model_restriction,
        daily_limit: formData.daily_limit,
        total_limit: formData.total_limit,
      };
      await updateApiKey(editingItem.value.id, updateData);
      MessagePlugin.success('更新成功');
    } else {
      // 创建
      const createData: CreateApiKeyRequest = {
        name: formData.name,
        key: formData.key || undefined,
        expires_at: formData.expires_at || undefined,
        status: formData.status,
        group_id: formData.group_id,
        model_restriction: formData.model_restriction,
        daily_limit: formData.daily_limit,
        total_limit: formData.total_limit,
      };
      await createApiKey(createData);
      MessagePlugin.success('创建成功');
    }

    formVisible.value = false;
    await fetchData();
  } catch (error) {
    console.error('操作失败:', error);
    MessagePlugin.error('操作失败');
  }
};

const handleFormCancel = () => {
  formVisible.value = false;
};

const handleToggleStatus = async (item: ApiKey) => {
  try {
    const newStatus = item.status === 1 ? 0 : 1;
    await updateApiKeyStatus(item.id, { status: newStatus });
    MessagePlugin.success(newStatus === 1 ? '已启用' : '已禁用');
    await fetchData();
  } catch (error) {
    console.error('状态更新失败:', error);
    MessagePlugin.error('状态更新失败');
  }
};

const handleDelete = (items: ApiKey[]) => {
  deleteItems.value = items;
  deleteVisible.value = true;
};

const handleDeleteConfirm = async () => {
  try {
    await Promise.all(deleteItems.value.map((item) => deleteApiKey(item.id)));
    MessagePlugin.success('删除成功');
    selectedRowKeys.value = [];
    await fetchData();
  } catch (error) {
    console.error('删除失败:', error);
    MessagePlugin.error('删除失败');
  } finally {
    deleteVisible.value = false;
  }
};

const handleDeleteCancel = () => {
  deleteVisible.value = false;
};

// 获取使用量状态
const getUsageStatus = (totalCost: number, totalLimit: number) => {
  if (totalLimit <= 0) return 'active';

  const percentage = (totalCost / totalLimit) * 100;

  if (percentage >= 95) return 'error';
  if (percentage >= 80) return 'warning';
  return 'success';
};

// 获取操作菜单选项
const getActionMenuOptions = (_row: ExtendedApiKey) => [
  {
    content: 'RPM/TPM 详情',
    value: 'rpm-tpm-detail',
    prefixIcon: () => h('t-icon', { name: 'chart-line' }),
  },
  {
    content: 'RPM/TPM 设置',
    value: 'rpm-tpm-settings',
    prefixIcon: () => h('t-icon', { name: 'setting' }),
  },
  {
    content: '查看历史趋势',
    value: 'rpm-tpm-history',
    prefixIcon: () => h('t-icon', { name: 'chart-bar' }),
  },
];

// 处理操作菜单点击
const handleActionMenu = (option: { value: string }, row: ExtendedApiKey) => {
  switch (option.value) {
    case 'rpm-tpm-detail':
      // 跳转到 RPM/TPM 详情页
      window.open(`/rpm-tpm/api-keys?id=${row.id}`, '_blank');
      break;
    case 'rpm-tpm-settings':
      // 跳转到 RPM/TPM 设置页
      window.open(`/rpm-tpm/api-keys?id=${row.id}&action=settings`, '_blank');
      break;
    case 'rpm-tpm-history':
      // 跳转到 RPM/TPM 历史页
      window.open(`/rpm-tpm/api-keys?id=${row.id}&action=history`, '_blank');
      break;
  }
};

// 生命周期
onMounted(() => {
  fetchData();
});
</script>
<style lang="less" scoped>
.list-card-container {
  padding: var(--td-comp-paddingTB-xxl) var(--td-comp-paddingLR-xxl);

  :deep(.t-card__body) {
    padding: 0;
  }
}

.left-operation-container {
  display: flex;
  align-items: center;
  margin-bottom: var(--td-comp-margin-xxl);

  .selected-count {
    display: inline-block;
    margin-left: var(--td-comp-margin-l);
    color: var(--td-text-color-secondary);
  }
}

.search-input {
  width: 360px;
}

.key-display {
  display: flex;
  align-items: center;
  gap: 8px;

  .key-text {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 12px;
    color: var(--td-text-color-primary);
  }
}

.usage-info {
  font-size: 12px;
  line-height: 1.4;

  p {
    margin: 2px 0;
  }
}

.text-placeholder {
  color: var(--td-text-color-placeholder);
}

.total-cost {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}

.preset-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

// RPM/TPM 状态样式
.rpm-tpm-status-cell {
  .usage-info {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 6px;
    font-size: 13px;

    .current-value {
      font-weight: 500;
      color: var(--td-text-color-primary);

      &.text-danger {
        color: var(--td-error-color);
      }
    }

    .limit-value {
      color: var(--td-text-color-secondary);
    }

    .unlimited-text {
      color: var(--td-text-color-placeholder);
      font-style: italic;
    }
  }
}
</style>
